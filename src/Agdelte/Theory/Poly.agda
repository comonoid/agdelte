{-# OPTIONS --without-K --safe #-}

-- Polynomial Functors - —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ Agdelte
-- –ù–∞ –±–∞–∑–µ —Ä–∞–±–æ—Ç –î—ç–≤–∏–¥–∞ –°–ø–∏–≤–∞–∫–∞ –∏ –ù–µ–ª—å—Å–æ–Ω–∞ –ù–∏—É
-- Poly = ‚àë(i : Pos) (Dir i ‚Üí -)
-- MVP –≤–µ—Ä—Å–∏—è: –±–µ–∑ universe polymorphism

module Agdelte.Theory.Poly where

open import Data.Product using (Œ£; _,_; proj‚ÇÅ; proj‚ÇÇ; _√ó_)
open import Data.Sum using (_‚äé_; inj‚ÇÅ; inj‚ÇÇ)
open import Data.Unit using (‚ä§; tt)
open import Data.Empty using (‚ä•)
open import Function using (_‚àò_; id)

------------------------------------------------------------------------
-- Polynomial Functor
------------------------------------------------------------------------

-- –ü–æ–ª–∏–Ω–æ–º: –Ω–∞–±–æ—Ä –ø–æ–∑–∏—Ü–∏–π (–≤—ã—Ö–æ–¥–æ–≤) –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–≤—Ö–æ–¥–æ–≤) –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
record Poly : Set‚ÇÅ where
  constructor mkPoly
  field
    Pos : Set             -- –ü–æ–∑–∏—Ü–∏–∏ (–≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã—Ö–æ–¥—ã)
    Dir : Pos ‚Üí Set       -- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ (–≤—Ö–æ–¥—ã)

open Poly public

------------------------------------------------------------------------
-- Interpretation: Poly –∫–∞–∫ —Ñ—É–Ω–∫—Ç–æ—Ä Set ‚Üí Set
------------------------------------------------------------------------

-- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏–Ω–æ–º–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É
‚ü¶_‚üß : Poly ‚Üí Set ‚Üí Set
‚ü¶ P ‚üß X = Œ£ (Pos P) Œª p ‚Üí Dir P p ‚Üí X

-- map –¥–ª—è —Ñ—É–Ω–∫—Ç–æ—Ä–∞
mapPoly : (P : Poly) {A B : Set} ‚Üí (A ‚Üí B) ‚Üí ‚ü¶ P ‚üß A ‚Üí ‚ü¶ P ‚üß B
mapPoly P f (p , k) = p , f ‚àò k

------------------------------------------------------------------------
-- Lens: –º–æ—Ä—Ñ–∏–∑–º –º–µ–∂–¥—É –ø–æ–ª–∏–Ω–æ–º–∞–º–∏
------------------------------------------------------------------------

-- –õ–∏–Ω–∑–∞ ‚Äî —ç—Ç–æ –ø–∞—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–π: –≤–ø–µ—Ä—ë–¥ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º, –Ω–∞–∑–∞–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
record Lens (P Q : Poly) : Set where
  constructor mkLens
  field
    onPos : Pos P ‚Üí Pos Q
    onDir : (p : Pos P) ‚Üí Dir Q (onPos p) ‚Üí Dir P p

open Lens public

-- –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–∏–Ω–∑–∞
idLens : {P : Poly} ‚Üí Lens P P
idLens = mkLens id (Œª _ ‚Üí id)

-- –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –ª–∏–Ω–∑
_‚àòL_ : {P Q R : Poly} ‚Üí Lens Q R ‚Üí Lens P Q ‚Üí Lens P R
(mkLens f g) ‚àòL (mkLens h k) = mkLens (f ‚àò h) (Œª p ‚Üí k p ‚àò g (h p))

------------------------------------------------------------------------
-- Coalgebra: —Å–∏—Å—Ç–µ–º–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
------------------------------------------------------------------------

-- –ö–æ–∞–ª–≥–µ–±—Ä–∞ –ø–æ–ª–∏–Ω–æ–º–∞ P ‚Äî —ç—Ç–æ —Ç–∏–ø —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å P
record Coalg (P : Poly) : Set‚ÇÅ where
  constructor mkCoalg
  field
    State : Set
    observe : State ‚Üí Pos P                           -- –ß—Ç–æ –≤—ã–¥–∞—ë–º
    update : (s : State) ‚Üí Dir P (observe s) ‚Üí State  -- –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ–º—Å—è

open Coalg public

------------------------------------------------------------------------
-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª–∏–Ω–æ–º—ã
------------------------------------------------------------------------

-- –¢–æ–∂–¥–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–ª–∏–Ω–æ–º: y (–æ–¥–∏–Ω –≤—Ö–æ–¥, –æ–¥–∏–Ω –≤—ã—Ö–æ–¥)
ùï™ : Poly
ùï™ = mkPoly ‚ä§ (Œª _ ‚Üí ‚ä§)

-- –ö–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–π –ø–æ–ª–∏–Ω–æ–º: A (—Ç–æ–ª—å–∫–æ –≤—ã—Ö–æ–¥—ã, –±–µ–∑ –≤—Ö–æ–¥–æ–≤)
Const : Set ‚Üí Poly
Const A = mkPoly A (Œª _ ‚Üí ‚ä•)

-- –ú–æ–Ω–æ–º–∏–∞–ª—å–Ω—ã–π –ø–æ–ª–∏–Ω–æ–º: A ¬∑ y^B
Mono : Set ‚Üí Set ‚Üí Poly
Mono A B = mkPoly A (Œª _ ‚Üí B)

------------------------------------------------------------------------
-- –ú–æ–Ω–æ–∏–¥–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
------------------------------------------------------------------------

-- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è (—Ç–µ–Ω–∑–æ—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ): P ‚äó Q
-- (p, q) –ø–æ–∑–∏—Ü–∏—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ
_‚äó_ : Poly ‚Üí Poly ‚Üí Poly
P ‚äó Q = mkPoly
  (Pos P √ó Pos Q)
  (Œª { (p , q) ‚Üí Dir P p ‚äé Dir Q q })

-- –°—É–º–º–∞ (–≤—ã–±–æ—Ä): P ‚äï Q
_‚äï_ : Poly ‚Üí Poly ‚Üí Poly
P ‚äï Q = mkPoly
  (Pos P ‚äé Pos Q)
  (Œª { (inj‚ÇÅ p) ‚Üí Dir P p ; (inj‚ÇÇ q) ‚Üí Dir Q q })

-- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è: P ‚óÅ Q
-- –ü–æ–∑–∏—Ü–∏—è ‚Äî –ø–∞—Ä–∞ (p, —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ Dir P p –≤ Pos Q)
-- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –∑–∞–≤–∏—Å–∏–º–∞—è –ø–∞—Ä–∞
_‚óÅ_ : Poly ‚Üí Poly ‚Üí Poly
P ‚óÅ Q = mkPoly
  (Œ£ (Pos P) Œª p ‚Üí Dir P p ‚Üí Pos Q)
  (Œª { (p , f) ‚Üí Œ£ (Dir P p) Œª d ‚Üí Dir Q (f d) })

------------------------------------------------------------------------
-- Wiring diagrams (—Å–≤—è–∑—É—é—â–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã)
------------------------------------------------------------------------

-- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–∞–ª–≥–µ–±—Ä
parallel : {P Q : Poly} ‚Üí Coalg P ‚Üí Coalg Q ‚Üí Coalg (P ‚äó Q)
parallel C D = mkCoalg
  (State C √ó State D)
  (Œª { (s , t) ‚Üí observe C s , observe D t })
  (Œª { (s , t) (inj‚ÇÅ d) ‚Üí update C s d , t
     ; (s , t) (inj‚ÇÇ d) ‚Üí s , update D t d })

-- –í—ã–±–æ—Ä –º–µ–∂–¥—É –∫–æ–∞–ª–≥–µ–±—Ä–∞–º–∏
choice : {P Q : Poly} ‚Üí Coalg P ‚Üí Coalg Q ‚Üí Coalg (P ‚äï Q)
choice C D = mkCoalg
  (State C ‚äé State D)
  (Œª { (inj‚ÇÅ s) ‚Üí inj‚ÇÅ (observe C s) ; (inj‚ÇÇ t) ‚Üí inj‚ÇÇ (observe D t) })
  (Œª { (inj‚ÇÅ s) d ‚Üí inj‚ÇÅ (update C s d) ; (inj‚ÇÇ t) d ‚Üí inj‚ÇÇ (update D t d) })

------------------------------------------------------------------------
-- –£—Ç–∏–ª–∏—Ç—ã
------------------------------------------------------------------------

-- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ–∞–ª–≥–µ–±—Ä—ã —á–µ—Ä–µ–∑ –ª–∏–Ω–∑—É
transformCoalg : {P Q : Poly} ‚Üí Lens P Q ‚Üí Coalg P ‚Üí Coalg Q
transformCoalg (mkLens f g) C = mkCoalg
  (State C)
  (f ‚àò observe C)
  (Œª s d ‚Üí update C s (g (observe C s) d))
